# Pluto Architecture

This document describes Pluto's internal architecture, including the runtime, services, gateway, and provider systems.

## Overview (At a Glance)

- **Durable, portable agents**: agent definitions are transparent YAML files + Markdown for unstructured content (see [Pluto Agent Format](./202601111200.pluto-agent-format.md)).
- **Stateless by default**: the runtime can crash/restart without hidden server-side state.
- **File-based state by default**: sessions, memory, and artifacts are persisted as files; external backends are optional.
- **Standards-first**: Agent Protocol API + MCP tools + A2A Agent Card for discovery.

## Design Principle: Stateless Like nginx

Pluto follows the nginx model:
- **Agent definitions are files** (or pushed via Admin API and persisted as files)
- **Stateless by default** — crash and restart, no hidden runtime state
- **File-based state by default** — session, memory, and artifacts are durable, portable files; external backends are optional

## Core Concepts

### Agent

An agent is defined by a transparent YAML file with unstructured content (e.g. prompts, instructions) stored as Markdown files. See [Pluto Agent Format](./202601111200.pluto-agent-format.md) for the full specification.

### Task

A task is a goal given to an agent (Agent Protocol concept):

```json
{
  "task_id": "task_xyz789",
  "input": "Summarize the latest news about AI agents",
  "agent_id": "agent_abc123",
  "status": "running",
  "steps": [...]
}
```

### Step

A step is one unit of work within a task:

```json
{
  "step_id": "step_001",
  "task_id": "task_xyz789",
  "input": "Search for AI agent news",
  "output": "Found 5 relevant articles...",
  "status": "completed"
}
```

### Memory

Memory persists across conversations:

```yaml
memory:
  # Short-term: recent conversation context
  short_term:
    backend: buffer
    max_tokens: 4000

  # Long-term: facts, preferences, learned information
  long_term:
    backend: filesystem     # Default, file-based state (portable)
    path: ./.pluto/memory/  # Markdown/JSON files (portable)
    # backend: mem0         # External backend (optional)
    # backend: postgres     # External backend (optional)
```

## High-Level Architecture

```
┌─────────────────────────────────────────────────────────────────┐
│                           Pluto                                 │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │                    Agent Registry                       │    │
│  │  In-memory map of loaded agents (from files or API)     │    │
│  │  - Lazy loading with LRU cache for scale                │    │
│  │  - Supports thousands of agents per instance            │    │
│  └─────────────────────────────────────────────────────────┘    │
│         │                │                      │               │
│         ▼                ▼                      ▼               │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────────┐  │
│  │   HTTP API  │  │  Admin API  │  │         CLI             │  │
│  │  (Agent     │  │  (Deploy/   │  │  (pluto serve/chat/run) │  │
│  │  Protocol)  │  │   Manage)   │  │                         │  │
│  └──────┬──────┘  └──────┬──────┘  └────────────┬────────────┘  │
│         │                │                      │               │
│         └────────────────┼──────────────────────┘               │
│                          │                                      │
│                          ▼                                      │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │                       Runner                            │    │
│  │  - Manages event loop                                   │    │
│  │  - Processes events from execution logic                │    │
│  │  - Commits state via Services                           │    │
│  │  - Streams responses to clients                         │    │
│  └─────────────────────────────────────────────────────────┘    │
│         │                │                      │               │
│         ▼                ▼                      ▼               │
│  ┌───────────┐    ┌───────────┐         ┌───────────┐           │
│  │    LLM    │    │   Tools   │         │ Services  │           │
│  │ Interface │    │   (MCP)   │         │ (Session, │           │
│  │           │    │           │         │  Memory,  │           │
│  │           │    │           │         │  Artifact)│           │
│  └───────────┘    └───────────┘         └───────────┘           │
│         │                │                      │               │
│         ▼                ▼                      ▼               │
│  ┌───────────┐    ┌───────────┐         ┌───────────┐           │
│  │ OpenRouter│    │MCP Server │         │ Filesystem│           │
│  │ OpenAI    │    │(external) │         │ (default) │           │
│  │ Anthropic │    │           │         │ External  │           │
│  │ Ollama    │    │           │         │ (opt.)    │           │
│  └───────────┘    └───────────┘         └───────────┘           │
└─────────────────────────────────────────────────────────────────┘
```

## Runtime Architecture (Event Loop Pattern)

Pluto uses a **simple event loop pattern** for execution.

### Core Agent Loop

```
User Message → LLM Call → Tool Calls? → Execute Tools → Feed Results → Repeat
                              │                              │
                              └── No tools ──────────────────┘
                                     │
                                     ▼
                              Return Response
```

This is intentionally minimal. No max step limits, no complex orchestration knobs. Complexity is added only when real use cases demand it.

However, Pluto is **safe by default**: the Runner enforces execution budgets (e.g. max wall time, token budget, tool-call budget) and supports cancellation to prevent runaway loops.

### Full Runtime Architecture

```
┌─────────────────────────────────────────────────────────────────┐
│                        Pluto Runtime                            │
│                                                                 │
│  User Input ───────► Runner ─────────────────► Services         │
│       │              (Event Processor)         (pluggable)      │
│       │                   │                        │            │
│       │              Event Loop              ┌─────┴─────┐      │
│       │              (Ask/Yield)             │           │      │
│       │                   │            SessionService    │      │
│       │                   ▼            MemoryService     │      │
│       │            Execution Logic     ArtifactService   │      │
│       │            (Agent, LLM,              │           │      │
│       │             Tools, Callbacks)        ▼           │      │
│       │                   │              Storage         │      │
│       ◄───────────────────┘              (Filesystem,    │      │
│      Stream<Event>                        External)      │      │
└─────────────────────────────────────────────────────────────────┘
```

### Key Components

| Component | Description |
|-----------|-------------|
| **Runner** | Orchestrator that manages event loop, receives queries, processes events |
| **Event Loop** | Ask/Yield pattern between Runner and Execution Logic |
| **Execution Logic** | Agents, LLM calls, tools, callbacks |
| **Services** | Pluggable backends for session, memory, artifacts |
| **Events** | Messages carrying content + details (separated for LLM vs UI) |

### Event Loop Flow

1. Runner receives user query, updates session history
2. Runner asks Execution Logic (agent) to process
3. Agent yields events (partial responses, tool calls, state changes)
4. Runner processes each event (commits state, streams to client)
5. Runner signals agent to resume
6. Repeat until agent yields final event

### Tool Result Structure

```go
type ToolResult struct {
    Content string      `json:"content"`   // For LLM consumption
    Details interface{} `json:"details"`   // For UI/client rendering
    Error   string      `json:"error,omitempty"`
}
```

**Benefits:**
- Streaming LLM responses with partial events
- State changes guaranteed committed before execution resumes
- Tool execution with proper side-effect handling
- Graceful cancellation support
- Clear separation of LLM content vs UI metadata

## Services Layer

Services handle all stateful operations. Built-in state is file-based (filesystem); external backends are optional:

```yaml
# pluto.yaml
services:
  session:
    backend: filesystem       # default (file-based)
    path: ./.pluto/sessions/  # JSON files (relative, portable)
    # backend: postgres       # external (optional)
    # backend: redis          # external (optional)

  memory:
    backend: filesystem       # default (file-based)
    path: ./.pluto/memory/    # Markdown/JSON files (relative, portable)
    # backend: mem0           # external (optional)
    # backend: postgres       # external (optional)

  artifacts:
    backend: filesystem       # default (file-based)
    path: ./.pluto/artifacts/ # (relative, portable)
    # backend: s3             # external (optional)
    # backend: gcs            # external (optional)
```

| Service | Purpose | Default Backend |
|---------|---------|-----------------|
| **SessionService** | Conversation threads, message history | Filesystem |
| **MemoryService** | Long-term knowledge, facts, entities | Filesystem |
| **ArtifactService** | Files, generated outputs | Filesystem |

## Agent Loading Modes

```yaml
# pluto.yaml
agents:
  # Mode 1: File-based (GitOps-friendly)
  static:
    path: ./.pluto/agents
    watch: true  # Auto-reload on file changes

  # Mode 2: API-deployed / dynamically managed (persisted for restart recovery)
  dynamic:
    path: ./.pluto/sys/dyn_agents

  # Lazy loading for scale (thousands of agents)
  lazy_load: true
  cache_size: 1000  # LRU cache
```

## Gateway Component

The Gateway handles external messaging providers and routes to agents.

For the MVP, the gateway is deliberately **in-tree and simple**: providers ship with Pluto, and the `Provider` interface is the stable seam. This keeps the core stable and avoids a premature plugin ecosystem.

### Provider Interface

All providers implement a common interface:

```go
// internal/gateway/provider.go
type Provider interface {
    // Identity
    Name() string
    Type() ProviderType  // telegram, whatsapp, discord, web, cli

    // Lifecycle
    Start(ctx context.Context) error
    Stop() error
    Health() HealthStatus

    // Messaging
    Send(ctx context.Context, msg OutgoingMessage) error
    OnMessage(handler MessageHandler)

    // Optional capabilities
    SupportsMedia() bool
    SupportsStreaming() bool
    MaxMessageLength() int
}

type MessageHandler func(ctx context.Context, msg IncomingMessage) error

type IncomingMessage struct {
    ProviderType  ProviderType
    ProviderMsgID string
    ChatID        string
    UserID        string
    Text          string
    Media         []Media
    Metadata      map[string]any
    Timestamp     time.Time
}

type OutgoingMessage struct {
    ChatID   string
    Text     string
    Media    []Media
    Metadata map[string]any
}
```

### Built-in Providers

| Provider | Status | Library | Notes |
|----------|--------|---------|-------|
| **Telegram** | v0.1 | [telebot](https://github.com/tucnak/telebot) | Bot API, full-featured |
| **Web** | v0.1 | Built-in HTTP/WebSocket | Browser-based chat UI |
| **CLI** | v0.1 | Built-in | Interactive terminal |
| **WhatsApp** | Future | [whatsmeow](https://github.com/tulir/whatsmeow) | Web protocol (Baileys-like) |
| **Discord** | Future | [discordgo](https://github.com/bwmarrin/discordgo) | Bot API |
| **Slack** | Future | [slack-go](https://github.com/slack-go/slack) | Bot API |

### Adding New Providers

For v1.0, adding a new provider requires modifying Pluto core:

1. Implement the `Provider` interface in `internal/gateway/providers/<name>/`
2. Register the provider in `internal/gateway/registry.go`
3. Add configuration parsing in `internal/config/`
4. Update documentation

**Future consideration (plugin path, not MVP):** If the requirement is there, add an **out-of-process Provider protocol** (HTTP/gRPC) and ship an `ExternalProvider` adapter that implements `Provider` by talking to that process. This enables third-party “provider plugins” with independent release cycles, without relying on Go's in-process plugin mechanisms.

Milestone-level sketch:
- Define a versioned `Provider` RPC contract (send, health, capabilities)
- Define an inbound message stream/callback channel (provider → gateway)
- Load external providers via config (command/path/URL) and treat them like built-ins

We won’t build this until there’s clear need; MCP/CLI tools are the preferred extensibility path for most integrations.

## Tools

### Skills vs MCP: When to Use Each

**Skills (Markdown-based):**
- Agent reads README on-demand, calls via bash
- More token-efficient (no upfront schema dump)
- Simpler to create (just a script + README)
- Visible and debuggable
- Best for: Simple integrations, personal tools, quick extensions

**MCP (Protocol-based):**
- Type-safe tool definitions
- Streaming support
- Ecosystem of pre-built servers
- Better for: Complex integrations, third-party tools, production use

**Pluto approach:** Support both. Let users choose the right tool for their needs.

## Standards Alignment

| Standard | How Pluto Aligns |
|----------|------------------|
| **[Agent Protocol](https://agentprotocol.ai/)** | Implements task/step management endpoints (canonical prefix: `/api/v1/`) |
| **[A2A Protocol](https://a2a-protocol.org/)** | Agent Card for discovery, future inter-agent communication |
| **[Open Agent Spec](https://arxiv.org/abs/2510.04173v3)** | Agent definition format inspired by OAS |
| **[MCP](https://modelcontextprotocol.io/)** | Tools integrate via MCP protocol |
| **[AGENTS.md](https://openai.com/index/agentic-ai-foundation/)** | Supports AGENTS.md for repository context |
| **OpenAPI** | API documented with OpenAPI spec |

### A2A Agent Card Support

Pluto agents can expose an [A2A Agent Card](https://a2a-protocol.org/latest/specification/) for discovery by other agents or orchestrators:

```
GET /agents/{name}/.well-known/agent.json
```

The Agent Card is auto-generated from the agent's PAF definition, providing:
- Agent identity and description
- Supported capabilities (streaming, tools, memory)
- Skills as A2A "skills" with input/output modes
- Security requirements

This enables future multi-agent scenarios where agents can discover and communicate with each other using the A2A protocol.

## Tech Stack

| Component | Choice | Rationale |
|-----------|--------|-----------|
| **Language** | Go | Fast, single binary, contributor-friendly, Ollama precedent |
| **HTTP** | `net/http` (+ minimal router if needed) | Stable stdlib core; avoid framework magic. Add a small router only if it meaningfully improves readability. |
| **CLI** | `flag`/`pflag` | Prefer the smallest interface that’s readable and stable; avoid heavy command trees unless needed. |
| **Config** | YAML (structured) + Markdown (unstructured) | YAML for structured config; Markdown for prompts/instructions. Keep parsing explicit (no “magic” config loaders). |
| **Default state store** | File-based (filesystem) | File-first, portable, zero dependencies |
| **LLM Client** | Custom (simple HTTP) | No heavy SDK dependencies |
| **MCP Client** | Custom | Implement MCP protocol |

## Directory Structure

```
pluto/
├── cmd/
│   └── pluto/
│       └── main.go              # CLI entrypoint
├── internal/
│   ├── config/
│   │   ├── config.go            # Load pluto.yaml, apply defaults
│   │   └── paths.go             # Resolve data_dir (./.pluto/) and subpaths
│   ├── api/
│   │   ├── server.go            # HTTP server
│   │   ├── handlers.go          # Request handlers
│   │   ├── a2a.go               # A2A Agent Card endpoint
│   │   └── middleware.go        # Logging, CORS, etc.
│   ├── gateway/
│   │   ├── gateway.go           # Gateway orchestrator
│   │   ├── provider.go          # Provider interface
│   │   ├── registry.go          # Provider registry
│   │   └── providers/
│   │       ├── telegram/        # Telegram provider (telebot)
│   │       │   ├── provider.go
│   │       │   └── webhook.go
│   │       ├── web/             # Web chat provider
│   │       │   ├── provider.go
│   │       │   └── handler.go
│   │       └── cli/             # CLI provider
│   │           └── provider.go
│   ├── runtime/
│   │   ├── runner.go            # Event loop orchestrator
│   │   ├── event.go             # Event types and handling
│   │   └── invocation.go        # Single request lifecycle
│   ├── agent/
│   │   ├── agent.go             # Agent struct
│   │   ├── loader.go            # Load agent.yaml (+ referenced Markdown files)
│   │   ├── executor.go          # Execution logic (yields events)
│   │   └── spec.go              # Agent spec types
│   ├── storage/
│   │   ├── interface.go         # StorageBackend interface
│   │   ├── file/                # File-based storage (default)
│   │   │   ├── memory.go        # Markdown memory files (./.pluto/memory/)
│   │   │   ├── session.go       # JSON session files (./.pluto/sessions/)
│   │   │   └── artifact.go      # Filesystem artifacts (./.pluto/artifacts/)
│   │   └── external/            # External storage backends
│   │       ├── postgres.go      # PostgreSQL backend
│   │       ├── redis.go         # Redis session backend
│   │       └── s3.go            # S3 artifact backend
│   ├── llm/
│   │   ├── interface.go         # LLM provider interface
│   │   ├── openrouter.go
│   │   ├── openai.go
│   │   ├── anthropic.go
│   │   └── ollama.go
│   ├── tools/
│   │   ├── interface.go         # Tool interface
│   │   ├── mcp.go               # MCP client
│   │   └── builtin/             # Built-in tools
│   └── export/
│       ├── exporter.go          # Export agent package
│       └── importer.go          # Import agent package
├── pkg/
│   └── spec/
│       └── v1/                  # Public spec types
├── examples/
│   ├── agents/                  # Example agents (agent.yaml + Markdown files)
│   └── docker-compose.yml       # Example deployment
├── docs/
│   ├── getting-started.md
│   ├── agent-spec.md
│   └── api-reference.md
├── Dockerfile
├── go.mod
├── go.sum
├── LICENSE                      # MIT
└── README.md
```
