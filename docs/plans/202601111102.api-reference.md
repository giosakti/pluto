# Pluto API Reference

This document describes Pluto's HTTP API and CLI commands.

## Transport Options

Pluto supports two transport modes:

**HTTP + SSE (Default):**
- REST API for requests
- Server-Sent Events for streaming responses
- Simpler for most use cases

**WebSocket (Real-time):**
- Full-duplex communication
- Better for interactive sessions
- Lower latency for streaming

```yaml
# pluto.yaml
server:
  http:
    port: 8080

  websocket:
    enabled: true
    port: 8081
    path: /ws
```

## Public API (Agent Interaction)

```
# Agent Info (read-only)
GET    /agents                               # List loaded agents
GET    /agents/{name}                        # Get agent info
GET    /agents/{name}/spec                   # Get agent spec (YAML)

# Chat (simple interface)
POST   /agents/{name}/chat                   # Send message, get response (supports session_id)
GET    /agents/{name}/chat/stream            # SSE stream for responses (supports session_id)

# Task Management (Agent Protocol)
POST   /ap/v1/agent/tasks                    # Create task
GET    /ap/v1/agent/tasks                    # List tasks
GET    /ap/v1/agent/tasks/{task_id}          # Get task
POST   /ap/v1/agent/tasks/{task_id}/steps    # Execute step
GET    /ap/v1/agent/tasks/{task_id}/steps    # List steps

# Memory (Extension)
GET    /agents/{name}/memory                 # Query memory
POST   /agents/{name}/memory                 # Add to memory
DELETE /agents/{name}/memory                 # Clear memory

# Health
GET    /livez                                # Liveness check
GET    /readyz                               # Readiness check
GET    /health                               # Alias (combined health)
GET    /version                              # Version info
```

## Admin API (Agent Management)

Used by orchestrators (systems that are build on top of pluto) to deploy/manage agents.

```
# Agent Deployment
POST   /admin/agents                         # Deploy agent (create/update)
DELETE /admin/agents/{name}                  # Remove agent
POST   /admin/reload                         # Reload all agents from disk

# Export/Import
GET    /admin/agents/{name}/export           # Export agent package
POST   /admin/agents/import                  # Import agent package

# Webhooks (optional)
POST   /admin/webhooks                       # Register webhook (e.g., on-ready)
```

## Admin API Authentication

```yaml
# pluto.yaml
admin:
  enabled: true
  token: ${PLUTO_ADMIN_TOKEN}  # Required for /admin/* endpoints
  # Or use mTLS for service-to-service
```

## Examples

### Deploy Agent via Admin API

```bash
# Deploy/update an agent
curl -X POST http://pluto:8080/admin/agents \
  -H "Authorization: Bearer ${PLUTO_ADMIN_TOKEN}" \
  -H "Content-Type: application/yaml" \
  -d '
apiVersion: pluto/v1
kind: Agent
metadata:
  name: user_12345
spec:
  model:
    provider: openrouter
    name: anthropic/claude-sonnet-4
  system_prompt: |
    You are a helpful assistant.
'

# Response
{
  "ok": true,
  "data": {
    "agent": "user_12345",
    "action": "created"
  },
  "request_id": "req_abc123"
}
```

### Simple Chat Endpoint

```bash
# Quick chat (non-Agent Protocol). If session_id is provided, Pluto resumes that conversation and appends history.
# If session_id is omitted, Pluto creates a new session_id.
curl -X POST http://localhost:8080/agents/my-assistant/chat \
  -H "Content-Type: application/json" \
  -d '{
    "message": "Hello, how are you?",
    "session_id": "optional-session-id"
  }'

# Response
{
  "ok": true,
  "data": {
    "response": "Hello! I'm doing well, thank you for asking. How can I help you today?",
    "session_id": "session_abc123"
  },
  "request_id": "req_abc123"
}
```

### Streaming Response (SSE)

```bash
# Start streaming
curl -N http://localhost:8080/agents/my-assistant/chat/stream \
  -H "Content-Type: application/json" \
  -d '{
    "message": "Write a short poem about coding",
    "session_id": "session_abc123"
  }'

# SSE events
event: start
data: {"session_id": "session_abc123"}

event: token
data: {"content": "In "}

event: token
data: {"content": "lines "}

event: token
data: {"content": "of "}

event: token
data: {"content": "code..."}

event: done
data: {"finish_reason": "stop"}
```

### Run a Task (Agent Protocol)

```bash
# Create a task (Agent Protocol run)
curl -X POST http://localhost:8080/ap/v1/agent/tasks \
  -H "Content-Type: application/json" \
  -d '{
    "input": "What is the capital of France?",
    "agent_id": "agent_abc123"
  }'

# Response
{
  "ok": true,
  "data": {
    "task_id": "task_xyz789",
    "status": "created"
  },
  "request_id": "req_abc123"
}

# Execute a step
curl -X POST http://localhost:8080/ap/v1/agent/tasks/task_xyz789/steps

# Response
{
  "ok": true,
  "data": {
    "step_id": "step_001",
    "output": "The capital of France is Paris.",
    "status": "completed",
    "is_last": true
  },
  "request_id": "req_abc123"
}
```

## CLI

```bash
# Start server
pluto serve --port 8080 --agents-dir ./.pluto/agents/

# Interactive chat
pluto chat --agent-dir ./.pluto/agents/my-agent/

# Run single prompt
pluto run --agent-dir ./.pluto/agents/my-agent/ "What is 2+2?"

# Export agent
pluto export --agent my-agent --output ./export/

# Import agent
pluto import --file ./export/my-agent.pluto/

# Validate agent spec
pluto validate ./.pluto/agents/my-agent/
```

### CLI Options

#### `pluto serve`

Start the Pluto server.

```
pluto serve [flags]

Flags:
  -p, --port int          HTTP port (default 8080)
  -a, --agents-dir string Path to agents directory (e.g. ./.pluto/agents/)
  -c, --config string     Path to config file (default pluto.yaml)
      --admin-token       Admin API token (or use PLUTO_ADMIN_TOKEN env)
      --watch             Watch for agent file changes (default true)
```

#### `pluto chat`

Interactive chat with an agent.

```
pluto chat [flags]

Flags:
  -a, --agent-dir string  Path to agent directory (contains agent.yaml + Markdown + skills/)
  -s, --session string    Session ID to resume (optional)
      --no-memory         Disable memory for this session
```

#### `pluto run`

Run a single prompt and exit.

```
pluto run [flags] <prompt>

Flags:
  -a, --agent-dir string  Path to agent directory (contains agent.yaml + Markdown + skills/)
  -o, --output string     Output format: text, json (default text)
```

#### `pluto validate`

Validate an agent specification.

```
pluto validate <agent_dir>

Exit codes:
  0  Valid agent spec
  1  Invalid agent spec (errors printed to stderr)
```

#### `pluto export`

Export an agent package (agent.yaml + referenced Markdown files + bundled skills).

```
pluto export [flags]

Flags:
  -a, --agent string      Agent name or path
  -o, --output string     Output directory
```

#### `pluto import`

Import an agent package.

```
pluto import [flags]

Flags:
  -f, --file string       Path to agent package (.pluto directory or .tar.gz)
      --name string       Override agent name
```
