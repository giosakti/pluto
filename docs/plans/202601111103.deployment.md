# Pluto Deployment Plan

This document describes Pluto's deployment modes, storage configuration, and gateway setup.

## Deployment Philosophy

> **"For simple deployments, be self-contained with file-based state. For complex deployments, delegate state to external systems."**

Pluto follows a **stateless core with pluggable state** philosophy. The same binary can run in two modes:

### Simple Mode (Self-Hosted Power Users)

```
┌──────────────────────────────────────────────────────────────┐
│                    pluto serve                               │
│                                                              │
│  ┌────────────────────────────────────────────────────────┐  │
│  │                  Gateway (embedded)                    │  │
│  │  Telegram ─┬─► Message Router ─► Agent Executor        │  │
│  │  Web      ─┤                                           │  │
│  │  CLI      ─┘                                           │  │
│  └────────────────────────────────────────────────────────┘  │
│                            │                                 │
│  ┌────────────────────────────────────────────────────────┐  │
│  │                  File-Based State                      │  │
│  │                                                        │  │
│  │  ./.pluto/                                             │  │
│  │  ├── agents/my-agent/                                  │  │
│  │  │   ├── agent.yaml         # Structured agent config  │  │
│  │  │   ├── SYSTEM_PROMPT.md   # Unstructured prompt      │  │
│  │  │   └── INSTRUCTIONS.md    # Unstructured instructions│  │
│  │  ├── memory/                                           │  │
│  │  │   ├── 2025-01-10.md      # Yesterday                │  │
│  │  │   └── 2025-01-11.md      # Today                    │  │
│  │  ├── sessions/                                         │  │
│  │  │   └── session_abc.json   # Conversation history     │  │
│  │  └── artifacts/                                        │  │
│  │      └── generated_file.txt                            │  │
│  └────────────────────────────────────────────────────────┘  │
└──────────────────────────────────────────────────────────────┘
```

**Key properties:**
- Zero external dependencies (single binary)
- All state is files (git-friendly, inspectable, editable)
- Memory is markdown files (human-readable)
- Gateway embedded for Telegram/WhatsApp/Web

### Complex Mode

```
┌─────────────────────────────────────────────────────────────┐
│                      External System                        │
│                                                             │
│  ┌───────────────────────────────────────────────────────┐  │
│  │                  Gateway Layer                        │  │
│  │  Telegram Webhook ─┬─► User Resolution                │  │
│  │  Web Controller   ─┤   (chat_id → user_id)            │  │
│  │  API              ─┘       │                          │  │
│  │                            ▼                          │  │
│  │                   Agent Config Lookup                 │  │
│  │                   (user_id → agent spec)              │  │
│  └────────────────────────────┬──────────────────────────┘  │
└───────────────────────────────┼─────────────────────────────┘
                                │ Agent Protocol API
                                ▼
┌─────────────────────────────────────────────────────────────┐
│              Pluto Worker Pool (Stateless)                  │
│                                                             │
│  ┌─────────┐ ┌─────────┐ ┌─────────┐                        │
│  │ Worker  │ │ Worker  │ │ Worker  │  (scale horizontally)  │
│  │   1     │ │   2     │ │   N     │                        │
│  └────┬────┘ └────┬────┘ └────┬────┘                        │
│       └───────────┴───────────┘                             │
│                   │                                         │
│  gateway.enabled: false  (Ext. sys handles routing)         │
│  services.*: external    (state in external services)       │
└───────────────────────────┬─────────────────────────────────┘
                            │
        ┌───────────────────┼───────────────────┐
        ▼                   ▼                   ▼
┌──────────────┐    ┌──────────────┐    ┌──────────────┐
│   Memory     │    │   Session    │    │  Artifacts   │
│ (PostgreSQL) │    │ (PostgreSQL) │    │    (S3)      │
└──────────────┘    └──────────────┘    └──────────────┘
```

**Key properties:**
- Workers are stateless (can restart/scale anytime)
- State is in external services (PostgreSQL, S3)
- Gateway disabled (application handles routing)
- Agent configs passed per-request or cached

### Why This Philosophy Works

| Aspect | Simple Mode | Complex Mode |
|--------|-------------|--------------|
| **Dependencies** | Zero (single binary) | External services |
| **Scalability** | Single instance | Horizontal workers |
| **Data durability** | Files (git-friendly) | Database (ACID) |
| **Debugging** | Read files directly | Query services |
| **Migration** | Start simple → upgrade | Full control |

**Precedents:**
- **Files → External backends** — Same runtime, different state backend
- **Ollama** — Local by default, can connect to external
- **nginx** — Config files, stateless process

## Storage Modes

Pluto supports two state modes: **file-based (default)** and **external backends**.

### File-Based State (Default)

```yaml
# pluto.yaml - Simple Mode
data_dir: ./.pluto/

services:
  session:
    backend: filesystem
    path: ./.pluto/sessions/
  memory:
    backend: filesystem
    path: ./.pluto/memory/
  artifacts:
    backend: filesystem
    path: ./.pluto/artifacts/
```

**Memory format (file mode):**
```markdown
# 2025-12-15

## Decisions Made
- Chose Telegram as primary interface
- Named the agent "Socrates"

## Preferences Learned
- User prefers bullet points
- Timezone: Asia/Jakarta

## Facts Stored
- User's blog: example.com
- Current project: pluto
```

### External Mode

```yaml
# pluto.yaml - Complex Mode
services:
  memory:
    backend: postgres
    url: ${DATABASE_URL}

  session:
    backend: postgres
    url: ${DATABASE_URL}

  artifacts:
    backend: s3
    bucket: my-artifacts
    region: us-east-1
```

### Storage Interface

Pluto keeps state concerns separate so deployments can mix-and-match backends (e.g., Postgres for sessions, File-based for memory, S3 for artifacts).

In code, this maps to three small interfaces instead of a single storage backend:

```go
type MemoryStore interface {
    Put(agentID string, entry MemoryEntry) error
    Query(agentID string, q MemoryQuery) ([]MemoryEntry, error)
    Export(agentID string) (io.Reader, error) // portable export (e.g. JSONL/MD)
}

type SessionStore interface {
    // Sessions are append-only event logs (better for durability and concurrency).
    Append(sessionID string, event SessionEvent) error
    Read(sessionID string, opts SessionReadOptions) ([]SessionEvent, error)
    Delete(sessionID string) error
}

type ArtifactStore interface {
    Put(agentID string, name string, data io.Reader, meta ArtifactMeta) (ArtifactRef, error)
    Get(ref ArtifactRef) (io.ReadCloser, error)
    List(agentID string, prefix string, limit int) ([]ArtifactRef, error)
}

type ArtifactRef struct {
    ID   string // stable identifier (or path for filesystem backends)
    Name string
    URL  string // optional (S3/GCS); empty for local filesystem
    Meta ArtifactMeta
}
```

### Switching Modes

Users can start with file mode and upgrade to external mode without changing agent definitions:

```yaml
# Start simple (filesystem)
services:
  memory: { backend: filesystem, path: ./.pluto/memory/ }
  session: { backend: filesystem, path: ./.pluto/sessions/ }
  artifact: { backend: filesystem, path: ./.pluto/artifacts/ }

# Later, upgrade (example: postgres memory)
services:
  memory: { backend: postgres, url: ${DATABASE_URL} }
```

## Gateway Configuration

### Embedded Gateway (Simple Mode)

For self-hosted power users, the gateway is built into Pluto:

```yaml
# pluto.yaml
gateway:
  enabled: true

  telegram:
    enabled: true
    token: ${TELEGRAM_BOT_TOKEN}

  web:
    enabled: true
    port: 8081

  # Future providers
  whatsapp:
    enabled: false
  discord:
    enabled: false
```

**How it works:**
1. Gateway receives message from Telegram/Web/CLI
2. Routes to the single configured agent (no user resolution needed)
3. Agent processes, returns response
4. Gateway sends response back through same channel

### External Gateway (Complex Mode)

For SaaS deployments, the application owns the gateway:

```yaml
# pluto.yaml
gateway:
  enabled: false  # Application handles this
```

**How it works:**
1. Application (e.g., Rails) receives webhook from Telegram
2. Application identifies user from `chat_id`
3. Application looks up user's agent configuration
4. Application calls Pluto worker via Agent Protocol API
5. Application sends response back to user

This separation allows:
- Application to handle authentication, billing, analytics
- Pluto workers to remain stateless and scalable
- Different gateway implementations per deployment

## Provider Configuration

```yaml
# pluto.yaml
gateway:
  enabled: true

  providers:
    telegram:
      enabled: true
      token: ${TELEGRAM_BOT_TOKEN}
      # Optional: webhook mode for production
      webhook:
        enabled: false
        url: https://example.com/webhook/telegram

    web:
      enabled: true
      port: 8081
      # Optional: authentication
      auth:
        enabled: false
        token: ${WEB_AUTH_TOKEN}

    cli:
      enabled: true  # Always available when running interactively
```

## Quick Start Examples

### Minimal Self-Hosted Setup

```bash
# 1. Create a file-based state directory (portable)
mkdir -p ./.pluto/agents/my-assistant/skills

# 2. Create unstructured files
cat > ./.pluto/agents/my-assistant/SYSTEM_PROMPT.md << 'EOF'
You are a helpful assistant.
EOF

cat > ./.pluto/agents/my-assistant/INSTRUCTIONS.md << 'EOF'
Keep responses concise and actionable.
EOF

# 3. Create agent definition
cat > ./.pluto/agents/my-assistant/agent.yaml << 'EOF'
apiVersion: pluto/v1
kind: Agent
metadata:
  name: my-assistant
spec:
  model: openrouter/anthropic/claude-sonnet-4
  system_prompt: ./SYSTEM_PROMPT.md
  instructions: ./INSTRUCTIONS.md
EOF

# (Optional) Add skills under ./.pluto/agents/my-assistant/skills/ and Pluto will discover them by default.

# 4. Run Pluto
export OPENROUTER_API_KEY=your-key
pluto serve --agents-dir ./.pluto/agents/

# 5. Chat via CLI
pluto chat --agent-dir ./.pluto/agents/my-assistant/
```
